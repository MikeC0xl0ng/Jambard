<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      canvas{ background-color: rgb(200, 200, 200); }
    </style>
  </head>
  <body>
    <canvas id="jamboard">
    </canvas>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script>

    var socket = io();

    var utente = "pippo";
    var linee = [];
    var linea;
    var col = "#000000";
    var mouse_is_down = false;

    var canvas = document.getElementById("jamboard");
    
    canvas.width = window.innerWidth *0.65;
    canvas.height = 300;

    socket.emit("imposta_utente", utente);

    $("#jamboard").mousedown(function(e){
      var posX = e.pageX - $("#jamboard").offset().left;
      var posY = e.pageY - $("#jamboard").offset().top;
      var punto = { x: posX, y: posY };
      linea = { linea: [punto], color: col};    
      socket.emit("crea_linea", linea);
      mouse_is_down = true;
    });

    $("#jamboard").mousemove(function(e){
      if (mouse_is_down){
        var posX = e.originalEvent.clientX;
        var posY = e.originalEvent.clientY;
        var punto = {x: posX, y: posY};
        socket.emit("aggiorna_linea", punto);
      }
    });

    $(document).mouseup(function(e){
      mouse_is_down = false;
      socket.emit("aggiorna_linea", linea);
    });

    socket.on("aggiorna_linea", function(o){
      var linea_ = o.linea;
      var utente_ = o.utente;
      drawLine(linea_, utente_);
    });

    function drawLine(linea_, utente_){
      var punto = linea_[0];
      var x = punto.x;
      var y = punto.y;
      var color = linea_.color;
      var ctx = canvas.getContext("2d");
      ctx.moveTo(x, y);
      for (let i=1; i < linea_.length; i++){
        punto = linea_[i];
        x = punto.x;
        y = punto.y;
        color = linea_.color;
        ctx.lineTo(x, y);
      }
      ctx.stroke();
    }

  </script>
</html>
